CREATE TABLE [dbo].[TM_APP_SETTING_CONFIG_VERSION] (
    [ASV_ID]      INT             IDENTITY (1, 1) NOT NULL,
    [ASV_VERSION] DECIMAL (10, 2) NOT NULL,
    [ASV_CST_ID]  INT             NOT NULL,
    PRIMARY KEY CLUSTERED ([ASV_ID] ASC),
    CONSTRAINT [FK_TM_APP_SETTING_CONFIG_VERSION_TS_CONFIG_SETTING_TYPE] FOREIGN KEY ([ASV_CST_ID]) REFERENCES [dbo].[TS_CONFIG_SETTING_TYPE] ([CST_ID])
);


GO
CREATE UNIQUE NONCLUSTERED INDEX [IX_UQ_TM_APP_SETTING_CONFIG_VERSION]
    ON [dbo].[TM_APP_SETTING_CONFIG_VERSION]([ASV_VERSION] ASC, [ASV_CST_ID] ASC);


GO
CREATE TRIGGER TRIG_TM_APP_SETTING_CONFIG_VERSION_UPDATE
    ON TM_APP_SETTING_CONFIG_VERSION
    AFTER UPDATE
    AS BEGIN
           SET NOCOUNT ON;
           INSERT INTO TM_HISTORY_APP_SETTING_CONFIG_VERSION ([HSV_VERSION], [HSV_CST_ID], [HSV_ASV_ID])
           SELECT A.ASV_VERSION,
                  A.ASV_CST_ID,
                  A.ASV_ID
           FROM   TM_APP_SETTING_CONFIG_VERSION AS a
                  INNER JOIN
                  inserted AS i
                  ON a.ASV_ID = i.[ASV_ID];
       END


GO
CREATE TRIGGER TRIG_TM_APP_SETTING_CONFIG_VERSION_INSERT
    ON TM_APP_SETTING_CONFIG_VERSION
    AFTER INSERT
    AS BEGIN
           SET NOCOUNT ON;
           INSERT INTO TM_HISTORY_APP_SETTING_CONFIG_VERSION ([HSV_ASV_ID], [HSV_VERSION], [HSV_CST_ID])
           SELECT A.ASV_ID,
                  A.ASV_VERSION,
                  A.ASV_CST_ID
           FROM   TM_APP_SETTING_CONFIG_VERSION AS a
                  INNER JOIN
                  inserted AS i
                  ON a.ASV_ID = i.ASV_ID;
       END
       IF NOT EXISTS (SELECT *
                      FROM   INFORMATION_SCHEMA.TABLES
                      WHERE  TABLE_NAME = N'TM_HISTORY_APP_SETTING_CONFIG_VERSION_DEPLOY')
           BEGIN
               CREATE TABLE [dbo].[TM_HISTORY_APP_SETTING_CONFIG_VERSION_DEPLOY] (
                   [HCD_ID]            INT           IDENTITY (1, 1) NOT NULL,
                   [HCD_DEPLOYED_TIME] DATETIME      DEFAULT getdate() NOT NULL,
                   [HCD_ASV_ID]        INT           NOT NULL,
                   [HCD_IP_ADDRESS]    VARCHAR (100) NOT NULL,
                   PRIMARY KEY CLUSTERED ([HCD_ID] ASC),
                   CONSTRAINT [FK_TM_HISTORY_APP_SETTING_CONFIG_VERSION_DEPLOY_TM_APP_SETTING_CONFIG_VERSION] FOREIGN KEY (HCD_ASV_ID) REFERENCES [TM_APP_SETTING_CONFIG_VERSION] ([ASV_ID])
               );
           END

